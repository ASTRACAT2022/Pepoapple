services:
  db:
    image: postgres:16
    environment:
      POSTGRES_DB: pepoapple
      POSTGRES_USER: pepoapple
      POSTGRES_PASSWORD: pepoapple
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pepoapple -d pepoapple"]
      interval: 5s
      timeout: 5s
      retries: 20

  redis:
    image: redis:7
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20

  api:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      APP_NAME: ${APP_NAME:-Pepoapple Core}
      APP_ENV: ${APP_ENV:-docker}
      APP_HOST: 0.0.0.0
      APP_PORT: 8080
      DATABASE_URL: ${DOCKER_DATABASE_URL:-postgresql+psycopg://pepoapple:pepoapple@db:5432/pepoapple}
      REDIS_URL: ${DOCKER_REDIS_URL:-redis://redis:6379/0}
      JWT_SECRET: ${JWT_SECRET:-change-me}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      REFRESH_TOKEN_EXPIRE_DAYS: ${REFRESH_TOKEN_EXPIRE_DAYS:-30}
      RATE_LIMIT_PER_MINUTE: ${RATE_LIMIT_PER_MINUTE:-120}
      BACKUP_DIR: /app/backups
      WEBHOOK_TIMEOUT_SECONDS: ${WEBHOOK_TIMEOUT_SECONDS:-5}
      CORS_ALLOW_ORIGINS: ${CORS_ALLOW_ORIGINS:-http://localhost:3000,http://127.0.0.1:3000}
      PUBLIC_API_BASE_URL: ${PUBLIC_API_BASE_URL:-http://localhost:8080}
    ports:
      - "8080:8080"
    volumes:
      - backups:/app/backups
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/api/v1/health', timeout=3)"]
      interval: 10s
      timeout: 5s
      retries: 20
    restart: unless-stopped

  seed:
    profiles: ["demo"]
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      API_BASE: http://api:8080
      SEED_SQUAD_NAME: ${SEED_SQUAD_NAME:-DOCKER-DEMO}
      NODE_1_TOKEN: ${NODE_1_TOKEN:-demo-node-1-token}
      NODE_2_TOKEN: ${NODE_2_TOKEN:-demo-node-2-token}
    command: ["python", "/app/scripts/seed_demo.py"]
    depends_on:
      api:
        condition: service_healthy
    restart: "no"

  node-agent-1:
    profiles: ["demo"]
    build:
      context: ./agent
      dockerfile: Dockerfile
    environment:
      AGENT_API_BASE_URL: http://api:8080
      AGENT_NODE_TOKEN: ${NODE_1_TOKEN:-demo-node-1-token}
      AGENT_HEARTBEAT_INTERVAL_SEC: ${AGENT_HEARTBEAT_INTERVAL_SEC:-15}
      AGENT_RUNTIME_MODE: ${AGENT_RUNTIME_MODE:-process}
      AGENT_DESIRED_PATH: /data/desired.json
      AGENT_CONFIG_PATH: /data/runtime.json
      AGENT_BACKUP_PATH: /data/runtime.backup.json
      AGENT_SINGBOX_CONFIG_PATH: /data/singbox.json
      AGENT_SINGBOX_BACKUP_PATH: /data/singbox.backup.json
      AGENT_SINGBOX_PID_PATH: /data/singbox.pid
      AGENT_SINGBOX_RUN_COMMAND: ${AGENT_SINGBOX_RUN_COMMAND:-sing-box run -D /data -c /data/singbox.json}
      AGENT_AWG2_CONFIG_PATH: /data/awg2.json
      AGENT_AWG2_BACKUP_PATH: /data/awg2.backup.json
      AGENT_AWG2_PID_PATH: /data/awg2.pid
      AGENT_AWG2_RUN_COMMAND: ${AGENT_AWG2_RUN_COMMAND:-awg2 -f wg0}
    volumes:
      - agent1-data:/data
    depends_on:
      api:
        condition: service_healthy
      seed:
        condition: service_completed_successfully
    restart: unless-stopped

  node-agent-2:
    profiles: ["demo"]
    build:
      context: ./agent
      dockerfile: Dockerfile
    environment:
      AGENT_API_BASE_URL: http://api:8080
      AGENT_NODE_TOKEN: ${NODE_2_TOKEN:-demo-node-2-token}
      AGENT_HEARTBEAT_INTERVAL_SEC: ${AGENT_HEARTBEAT_INTERVAL_SEC:-15}
      AGENT_RUNTIME_MODE: ${AGENT_RUNTIME_MODE:-process}
      AGENT_DESIRED_PATH: /data/desired.json
      AGENT_CONFIG_PATH: /data/runtime.json
      AGENT_BACKUP_PATH: /data/runtime.backup.json
      AGENT_SINGBOX_CONFIG_PATH: /data/singbox.json
      AGENT_SINGBOX_BACKUP_PATH: /data/singbox.backup.json
      AGENT_SINGBOX_PID_PATH: /data/singbox.pid
      AGENT_SINGBOX_RUN_COMMAND: ${AGENT_SINGBOX_RUN_COMMAND:-sing-box run -D /data -c /data/singbox.json}
      AGENT_AWG2_CONFIG_PATH: /data/awg2.json
      AGENT_AWG2_BACKUP_PATH: /data/awg2.backup.json
      AGENT_AWG2_PID_PATH: /data/awg2.pid
      AGENT_AWG2_RUN_COMMAND: ${AGENT_AWG2_RUN_COMMAND:-awg2 -f wg0}
    volumes:
      - agent2-data:/data
    depends_on:
      api:
        condition: service_healthy
      seed:
        condition: service_completed_successfully
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://localhost:8080}
      NEXT_PUBLIC_API_SCOPES: ${NEXT_PUBLIC_API_SCOPES:-*}
      NEXT_TELEMETRY_DISABLED: 1
    ports:
      - "3000:3000"
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped

  subscription-page:
    build:
      context: ./subscription-page
      dockerfile: Dockerfile
    environment:
      PANEL_API_BASE_URL: ${SUBPAGE_PANEL_API_BASE_URL:-http://api:8080}
      PAGE_TITLE: ${SUBPAGE_PAGE_TITLE:-Pepoapple Subscription}
      SUPPORT_URL: ${SUBPAGE_SUPPORT_URL:-https://t.me/}
      SHOW_RAW_LINKS: ${SUBPAGE_SHOW_RAW_LINKS:-true}
      CUSTOM_SUB_PREFIX: ${SUBPAGE_CUSTOM_SUB_PREFIX:-}
    ports:
      - "3010:3010"
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped

volumes:
  pgdata:
  backups:
  agent1-data:
  agent2-data:
